{% extends "base/page.html" %}
{% load staticfiles %}
{% block content %}

<style>
body {
  margin: 0;
  padding: 0;
}

.modal-dialog {
    margin: 20vh auto 0px auto
}

.btn-rounded {
    border-radius: 10em;
}

.question-button {
  float: right;
  line-height:0;
  padding-top:5px;
  cursor: pointer
}

.description {
  padding: 22px 52px;
  background-color: rgba(81, 92, 230, 0.1);
  line-height: 1.4em;
}

.description,
.description a {
  font-family: Arial;
  font-size: 14px;
  color: #515ce6;
}

.article p {
  /* maybe 400 here? */
  font-weight: 300;
}
.article a {
  font-weight: 600;
}

.contents {
  padding: 20px 52px;
}
</style>

<!-- Editor's Dependencies -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.48.4/codemirror.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
<!-- Editor's Extension Dependencies -->
<link rel="stylesheet" href="https://uicdn.toast.com/tui.chart/v3.7.0/tui-chart.css">
<link rel="stylesheet" href="https://uicdn.toast.com/tui-color-picker/v2.2.1/tui-color-picker.css">
<!-- Editor -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tui-editor/1.4.6/tui-editor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tui-editor/1.4.6/tui-editor-contents.css">

<div class="container" style='padding-top:150px'>
  {% include "messages/message.html" %}
  <div class="row" style="margin-bottom:20px">
      <div class="col-md-12">{% if request.user.is_superuser or request.user.is_staff %}<a href="{% url 'admin:main_article_change' instance.uuid %}"><button class="btn btn-info btn-rounded">Edit</button></a>{% endif %}
             <a href="{% url 'download_articles_json' instance.uuid %}" style="float:right"><button class="btn btn-sm btn-indigo btn-rounded">(json)</button></a>
             <a href="{% url 'download_article_text' instance.uuid %}" style="float:right"><button class="btn btn-sm btn-indigo btn-rounded">Download (txt)</button></a>
 <i style="cursor:help" title="Share the term or download in multiple formats."></i>
      </div>
  </div>
  <div class="row">
    <div class="col-md-12">
        <nav>
            <div class="nav nav-tabs nav-fill" id="nav-tab" role="tablist">
                <a class="nav-item nav-link active" id="nav-details-tab" data-toggle="tab" href="#nav-details" role="tab" aria-controls="nav-details" aria-selected="true">{{ instance.namespace }}/{{ instance.name }}</a>
                {% if instance.pullrequest_set.count > 0 %}<a class="nav-item nav-link" id="nav-review-tab" data-toggle="tab" href="#nav-review" role="tab" aria-controls="nav-review" aria-selected="true">Review</a>{% endif %}
                {% if instance.question_set.count > 0 %}<a class="nav-item nav-link" id="nav-questions-tab" data-toggle="tab" href="#nav-questions" role="tab" aria-controls="nav-questions" aria-selected="true">Questions</a>{% endif %}
                {% if instance.example_set.count > 0 %}<a class="nav-item nav-link" id="nav-examples-tab" data-toggle="tab" href="#nav-examples" role="tab" aria-controls="nav-examples" aria-selected="true">Examples</a>{% endif %}
                {% if request.user.has_github_create %}<a class="nav-item nav-link" id="nav-edit-tab" data-toggle="tab" href="#nav-edit" role="tab" aria-controls="nav-edit" aria-selected="true"><i class="fas fa-edit"></i></a>{% endif %}
                <a class="nav-item nav-link" id="nav-github-tab" target="_blank" href="https://github.com/{{ instance.repo.full_name }}" role="tab" aria-controls="nav-github" aria-selected="true"><i style="color:black" class="fab fa-github"></i></a>
            </div>
        </nav>
        <div class="tab-content" id="nav-tabContent">
            <div class="tab-pane fade show active tui-editor-contents article"
                 style="padding: 30px; background-color:#F8F8F8;"
                 id="nav-details" role="tabpanel" style="padding-top:20px" aria-labelledby="nav-details-tab">
              {{ instance.html | safe }}
            </div>
            {% if request.user.has_github_create %}<div class="tab-pane fade" id="nav-edit" 
                                                        style="margin-top:20px"
                                                        role="tabpanel" aria-labelledby="nav-edit-tab">
                <form id="form" method="post">{% csrf_token %}
                    <div class="description" id="response-messages">
                       Click the left box to edit the term, and submit to request review for your changes.
                    </div>
                    <div class="contents code-html">
                        <div id="editSection"></div>
                    </div>
                    <button class="btn btn-info" id="submit-button"><i class="save icon"></i> Submit</button>
                </form>  
            </div>{% endif %}
            {% if instance.pullrequest_set.count > 0 %}<div class="tab-pane fade" id="nav-review" 
                                                        style="margin-top:20px"
                                                        role="tabpanel" aria-labelledby="nav-review-tab">
                 {% for pr in instance.pullrequest_set.all %}<div class="row">
                   <div class="col-md-12">
                     <div class="card">
                       <div class="card-body">
                          {% if pr.url %}<a href="{{ pr.url }}">{% endif %}<strong><span style="margin-right:30px" class="badge badge-{% if pr.status == 'pending' %}primary{% else %}success{% endif %}">{{ pr.status }}</span></strong>{% if pr.url %}</a>{% endif %} submit by {{ pr.owner.username }} on {{ pr.created }} {% if pr.url %}<a style="float:right" href="{{ pr.url }}">View on GitHub</a>{% endif %}
                       </div>
                     </div>
                   </div>
                 </div>{% endfor %}
            </div>{% endif %}

            {% if instance.question_set.count > 0 %}
            <div class="tab-pane fade" id="nav-questions" 
                 style="margin-top:20px"
                 role="tabpanel" aria-labelledby="nav-questions-tab">
                 {% for question in instance.question_set.all %}<div class="row">
                   <div class="col-md-12">
                     <div class="card">
                       <div class="card-body">
                          <strong><a class="question-link" href="#{{ question.text }}"> {{ question.pretty }}</a></strong>
                       </div>
                     </div>
                   </div>
                 </div>{% endfor %}
            </div>{% endif %}

            {% if instance.example_set.count > 0 %}
            <div class="tab-pane fade" id="nav-examples" 
                 style="margin-top:20px"
                 role="tabpanel" aria-labelledby="nav-examples-tab">
                 {% for example in instance.example_set.all %}<div class="row">
                   <div class="col-md-12">
                     <div class="card">
                       <div class="card-body">
                          <strong><a class="question-link" href="#{{ example.text }}"> {{ example.pretty }}</a></strong>
                       </div>
                     </div>
                   </div>
                 </div>{% endfor %}
            </div>{% endif %}

        </div>
     </div>
  </div>
  <div class="row" style="padding-top:20px">
      <div class="col-md-12">
          <span style="float:right"><a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-show-count="false">Tweet</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></span>
      </div>
   </div>

<div class="modal fade" id="modalQuestionForm" tabindex="-1" role="dialog" aria-labelledby="questionModalLabel"
  aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">What is your question?</h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <i class="fas fa-question prefix grey-text"></i>
          <input type="text" id="question-field" class="form-control" style="margin-bottom:20px">
        </div>
      </div>
      <div class="modal-footer d-flex justify-content-center">
        <button id="ask-question-button" class="btn btn-default">Insert</button>
      </div>
    </div>
  </div>
</div>
</div>
{% endblock %}
{% block pagescripts %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tui-editor/1.4.6/tui-editor-Editor-full.js"></script>
    <script class="code-js">
      {% if instance.text %}var content = [{% for line in instance.lines %}
        '{{ line | escapejs }}'{% if forloop.last %}{% else %},{% endif %}{% endfor %}
      ].join('\n');{% else %}
      var content = ['# {{ instance.name }}'];{% endif %}

      var editor = new tui.Editor({
        el: document.querySelector('#editSection'),
        previewStyle: 'vertical',
        height: '400px',
        initialEditType: 'markdown',
        initialValue: content,
        exts: [
          {
            name: 'chart',
            minWidth: 100,
            maxWidth: 600,
            minHeight: 100,
            maxHeight: 300
          },
          'scrollSync',
          'colorSyntax',
          'uml',
          'mark',
          'table'
        ],
        toolbarItems: [
          'heading',
          'bold',
          'italic',
          'strike',
          'divider',
          'hr',
          'quote',
          'divider',
          'ul',
          'ol',
          'task',
          'indent',
          'outdent',
          'divider',
          'table',
          'image',
          'link',
          'divider',
          'code',
          'codeblock',
          'divider',
          {
            type: 'button',
            options: {
              $el: $('<div data-toggle="modal" data-target="#modalQuestionForm" class="tui-code tui-toolbar-icons question-button"><i class="fas fa-question"></i></div>'),
              name: 'AskQuestion',
              className: '',
              command: 'AskQuestion',
              tooltip: 'Insert a question'
            }
          } 
       ]
      });

      // Insert question into text when user asks it
      $("#ask-question-button").click(function(){
          question = $("#question-field").val();
          question = question.replace(/[^0-9a-z ]/gi, '');
          question = question.toLowerCase().replace(/ /g, '-');
          console.log(question)
          if (question != "") {
              const textObj = editor.getTextObject();
              const range = editor.getRange();
              textObj.setEndBeforeRange(range);
              question = "<span id='question-" + question + "'>\n\n"
              textObj.replaceContent(question);
              $('#modalQuestionForm').modal('hide');
              $("#question-field").val("");
          }
      })

    </script>
<script>
$(document).ready(function() {

  // Ensure that we switch to the content tab when a question is provided
  let url = location.href.replace(/\/$/, "");
 
  function navigate() {
    const hash = url.split("#");
    $('#nav-details a[href="#'+hash[1]+'"]').tab("show");
    $('#nav-details-tab').addClass('active');
    $('#nav-details').addClass('show active');
    $('#nav-questions-tab').removeClass('active');
    $('#nav-questions').removeClass('show active');
  }

  if (location.hash) {
    navigate();
    url = location.href.replace(/\/#/, "#");
    history.replaceState(null, null, url);
  } 
   
  $(".question-link").click(function(event) {
     navigate()
  });

  $("#submit-button").click(function(event) {
     event.preventDefault();

     var url = "{% url 'article_details' instance.name %}";
     let form = document.getElementById('form');
     let data = new FormData(form);
     data.append('csrfmiddlewaretoken', $('input[name="csrfmiddlewaretoken"]').attr('value'));
     data.append('markdown', editor.getMarkdown());
     console.log(data)
     fetch(url, {
       method: 'POST',
       body: data,
       credentials: 'same-origin'
     }).then(res => res.json()) 
    .then(function(response) {
      console.log('Response:', response)
      // If a message is provided, show it
      if ("message" in response) {
         $("#response-messages").text(response['message'])
         $("#response-messages").show();
         if (response['message'] == "success") {
             document.location = "{{ article.get_absolute_url }}";
         }
      } else {
         $("#response-messages").text()
         $("#response-messages").hide();
      }

    })
    .catch(function(response) {
       var response = JSON.stringify(response);
       console.log("Error", response)
       event.preventDefault();
    })
  });
});
</script>
{% endblock %}
